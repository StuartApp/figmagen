


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > ColorsTask</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/highlight-idea.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.stuart.figmagen.tasks</a>
</div>

<h1>Coverage Summary for Class: ColorsTask (com.stuart.figmagen.tasks)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
<th class="coverageStat 
">
  Instruction, %
</th>
</tr>
<tr>
  <td class="name">ColorsTask</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (4/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    66.7%
  </span>
  <span class="absValue">
    (24/36)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    85.7%
  </span>
  <span class="absValue">
    (48/56)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    80.3%
  </span>
  <span class="absValue">
    (285/355)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ColorsTask$checkThemesCorrectness$2$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/15)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ColorsTask$getColors$2</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
    <td class="coverageStat"/>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (8/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (52/52)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ColorsTask$getColors$2$1$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (2/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (3/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    98.2%
  </span>
  <span class="absValue">
    (54/55)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ColorsTask$getColors$3</td>
    <td class="coverageStat"/>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    85.7%
  </span>
  <span class="absValue">
    (6/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    65%
  </span>
  <span class="absValue">
    (26/40)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    86.8%
  </span>
  <span class="absValue">
    (59/68)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    82%
  </span>
  <span class="absValue">
    (391/477)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<div class="sourceCode" id="sourceCode"><i class="no-highlight">1</i>&nbsp;package com.stuart.figmagen.tasks
<i class="no-highlight">2</i>&nbsp;
<i class="no-highlight">3</i>&nbsp;import com.stuart.figmagen.Task
<i class="no-highlight">4</i>&nbsp;import com.stuart.figmagen.internal.FigmaApi
<i class="no-highlight">5</i>&nbsp;import com.stuart.figmagen.internal.await
<i class="no-highlight">6</i>&nbsp;import com.stuart.figmagen.internal.baseRequest
<i class="no-highlight">7</i>&nbsp;import com.stuart.figmagen.internal.baseUrl
<i class="no-highlight">8</i>&nbsp;import com.stuart.figmagen.internal.client
<i class="no-highlight">9</i>&nbsp;import com.stuart.figmagen.internal.fileJsonAdapter
<i class="no-highlight">10</i>&nbsp;import com.stuart.figmagen.internal.getStyles
<i class="no-highlight">11</i>&nbsp;import com.stuart.figmagen.internal.nodeIdsAsQueryParameter
<i class="no-highlight">12</i>&nbsp;import com.stuart.figmagen.models.Color
<i class="no-highlight">13</i>&nbsp;import com.stuart.figmagen.models.FileKey
<i class="no-highlight">14</i>&nbsp;import com.stuart.figmagen.models.TaskFile
<i class="no-highlight">15</i>&nbsp;import com.stuart.figmagen.models.isColor
<i class="no-highlight">16</i>&nbsp;import kotlinx.coroutines.async
<i class="no-highlight">17</i>&nbsp;import kotlinx.coroutines.awaitAll
<i class="no-highlight">18</i>&nbsp;import kotlinx.coroutines.coroutineScope
<i class="no-highlight">19</i>&nbsp;import okhttp3.Request
<i class="no-highlight">20</i>&nbsp;
<i class="no-highlight">21</i>&nbsp;/**
<i class="no-highlight">22</i>&nbsp; * This task get the colors from a list of Figma files that has to be provided as instance of
<i class="no-highlight">23</i>&nbsp; * `ThemeFile`.
<i class="no-highlight">24</i>&nbsp; *
<i class="no-highlight">25</i>&nbsp; * A `ThemeFile` associates a theme with a Figma file, for example
<i class="no-highlight">26</i>&nbsp; *
<i class="no-highlight">27</i>&nbsp; * ```kotlin
<i class="no-highlight">28</i>&nbsp; * val lightThemeFile = ThemeFile(&quot;light&quot;, &quot;auAVu6zRJ39zECKv6hWDmH&quot;)
<i class="no-highlight">29</i>&nbsp; * val darkThemeFile = ThemeFile(&quot;light&quot;, &quot;wizOikAT1Wigtx6zHpfC87&quot;)
<i class="no-highlight">30</i>&nbsp; * ```
<i class="no-highlight">31</i>&nbsp; *
<i class="no-highlight">32</i>&nbsp; * There are default implementations of `ColorsTask` for multiple languages or frameworks, for
<i class="no-highlight">33</i>&nbsp; * example for Kotlin Compose UI framework.
<i class="no-highlight">34</i>&nbsp; */
<b class="fc"><i class="no-highlight">35</i>&nbsp;public abstract class ColorsTask : Task() {</b>
<i class="no-highlight">36</i>&nbsp;
<i class="no-highlight">37</i>&nbsp;    public abstract val themeFiles: List&lt;ThemeFile&gt;
<i class="no-highlight">38</i>&nbsp;
<i class="no-highlight">39</i>&nbsp;    public abstract override suspend fun run(): List&lt;TaskFile&gt;
<i class="no-highlight">40</i>&nbsp;
<b class="fc"><i class="no-highlight">41</i>&nbsp;    public suspend fun getColors(): List&lt;Color&gt; = coroutineScope {</b>
<b class="fc"><i class="no-highlight">42</i>&nbsp;        themeFiles</b>
<b class="fc"><i class="no-highlight">43</i>&nbsp;            .map { themeFile -&gt;</b>
<b class="fc"><i class="no-highlight">44</i>&nbsp;                val (theme: String, fileKey: FileKey) = themeFile</b>
<b class="fc"><i class="no-highlight">45</i>&nbsp;                async {</b>
<b class="fc"><i class="no-highlight">46</i>&nbsp;                    val colors = getColors(themeFile = themeFile)</b>
<b class="pc"><i class="no-highlight">47</i>&nbsp;                    check(colors.isNotEmpty()) { &quot;the file key `$fileKey` has no colors&quot; }</b>
<b class="fc"><i class="no-highlight">48</i>&nbsp;                    theme to colors</b>
<i class="no-highlight">49</i>&nbsp;                }
<i class="no-highlight">50</i>&nbsp;            }
<b class="fc"><i class="no-highlight">51</i>&nbsp;            .awaitAll()</b>
<b class="fc"><i class="no-highlight">52</i>&nbsp;            .toMap()</b>
<b class="fc"><i class="no-highlight">53</i>&nbsp;            .values</b>
<b class="fc"><i class="no-highlight">54</i>&nbsp;            .flatten()</b>
<i class="no-highlight">55</i>&nbsp;    }
<i class="no-highlight">56</i>&nbsp;
<i class="no-highlight">57</i>&nbsp;    public open suspend fun getColors(themeFile: ThemeFile): List&lt;Color&gt; {
<b class="fc"><i class="no-highlight">58</i>&nbsp;        val (theme: String, fileKey: FileKey) = themeFile</b>
<i class="no-highlight">59</i>&nbsp;
<b class="fc"><i class="no-highlight">60</i>&nbsp;        println(&quot;Getting colors for the theme $theme and the fileKey `$fileKey`&quot;)</b>
<i class="no-highlight">61</i>&nbsp;
<b class="fc"><i class="no-highlight">62</i>&nbsp;        val figmaStyle: List&lt;FigmaApi.Style&gt; = getStyles(fileKey.value, figmaToken)</b>
<i class="no-highlight">63</i>&nbsp;
<b class="fc"><i class="no-highlight">64</i>&nbsp;        val request: Request =</b>
<b class="fc"><i class="no-highlight">65</i>&nbsp;            baseRequest(figmaToken)</b>
<b class="fc"><i class="no-highlight">66</i>&nbsp;                .url(</b>
<b class="fc"><i class="no-highlight">67</i>&nbsp;                    baseUrl</b>
<b class="fc"><i class="no-highlight">68</i>&nbsp;                        .newBuilder()</b>
<b class="fc"><i class="no-highlight">69</i>&nbsp;                        .addPathSegment(fileKey.value)</b>
<b class="fc"><i class="no-highlight">70</i>&nbsp;                        .addPathSegment(&quot;nodes&quot;)</b>
<b class="fc"><i class="no-highlight">71</i>&nbsp;                        .addQueryParameter(&quot;ids&quot;, figmaStyle.nodeIdsAsQueryParameter())</b>
<b class="fc"><i class="no-highlight">72</i>&nbsp;                        .build()</b>
<i class="no-highlight">73</i>&nbsp;                )
<b class="fc"><i class="no-highlight">74</i>&nbsp;                .build()</b>
<i class="no-highlight">75</i>&nbsp;
<b class="fc"><i class="no-highlight">76</i>&nbsp;        val response = client.newCall(request).await()</b>
<i class="no-highlight">77</i>&nbsp;
<b class="fc"><i class="no-highlight">78</i>&nbsp;        val content: String =</b>
<b class="pc"><i class="no-highlight">79</i>&nbsp;            checkNotNull(response.body?.string()) {</b>
<b class="nc"><i class="no-highlight">80</i>&nbsp;                &quot;The request body for getting the Figma colors must not be null, check the file provided&quot;</b>
<i class="no-highlight">81</i>&nbsp;            }
<i class="no-highlight">82</i>&nbsp;
<b class="pc"><i class="no-highlight">83</i>&nbsp;        if (response.code == 200) {</b>
<b class="fc"><i class="no-highlight">84</i>&nbsp;            val data: FigmaApi.File =</b>
<b class="pc"><i class="no-highlight">85</i>&nbsp;                checkNotNull(fileJsonAdapter.fromJson(content)) {</b>
<b class="nc"><i class="no-highlight">86</i>&nbsp;                    &quot;There were an issue parsing the content to `FigmaApi.File`&quot;</b>
<i class="no-highlight">87</i>&nbsp;                }
<i class="no-highlight">88</i>&nbsp;
<b class="fc"><i class="no-highlight">89</i>&nbsp;            val colors: List&lt;Color&gt; =</b>
<b class="fc"><i class="no-highlight">90</i>&nbsp;                data.nodes.mapNotNull { (_, value) -&gt;</b>
<b class="pc"><i class="no-highlight">91</i>&nbsp;                    val color: FigmaApi.Color? = value.document.fills.firstOrNull()?.color</b>
<b class="fc"><i class="no-highlight">92</i>&nbsp;                    val path: String = value.document.name</b>
<b class="fc"><i class="no-highlight">93</i>&nbsp;                    val pathAsList: List&lt;String&gt; = path.split(&quot;/&quot;)</b>
<b class="fc"><i class="no-highlight">94</i>&nbsp;                    val isValidColor: Boolean =</b>
<b class="pc"><i class="no-highlight">95</i>&nbsp;                        color != null &amp;&amp; pathAsList.size &gt;= 3 &amp;&amp; pathAsList.isColor</b>
<i class="no-highlight">96</i>&nbsp;
<b class="fc"><i class="no-highlight">97</i>&nbsp;                    if (color != null &amp;&amp; isValidColor) {</b>
<b class="fc"><i class="no-highlight">98</i>&nbsp;                        val rgba: Color.RGBA =</b>
<b class="fc"><i class="no-highlight">99</i>&nbsp;                            Color.RGBA(</b>
<b class="fc"><i class="no-highlight">100</i>&nbsp;                                red = color.r,</b>
<b class="fc"><i class="no-highlight">101</i>&nbsp;                                green = color.g,</b>
<b class="fc"><i class="no-highlight">102</i>&nbsp;                                blue = color.b,</b>
<b class="fc"><i class="no-highlight">103</i>&nbsp;                                alpha = color.a</b>
<i class="no-highlight">104</i>&nbsp;                            )
<i class="no-highlight">105</i>&nbsp;
<b class="fc"><i class="no-highlight">106</i>&nbsp;                        Color(</b>
<b class="fc"><i class="no-highlight">107</i>&nbsp;                            path = path,</b>
<b class="fc"><i class="no-highlight">108</i>&nbsp;                            theme = theme,</b>
<b class="fc"><i class="no-highlight">109</i>&nbsp;                            rgba = rgba,</b>
<i class="no-highlight">110</i>&nbsp;                        )
<b class="fc"><i class="no-highlight">111</i>&nbsp;                    } else null</b>
<i class="no-highlight">112</i>&nbsp;                }
<i class="no-highlight">113</i>&nbsp;
<b class="fc"><i class="no-highlight">114</i>&nbsp;            return colors</b>
<b class="nc"><i class="no-highlight">115</i>&nbsp;        } else error(&quot;There is an error: Status code: ${response.code}, body: ${response.body}&quot;)</b>
<i class="no-highlight">116</i>&nbsp;    }
<i class="no-highlight">117</i>&nbsp;
<i class="no-highlight">118</i>&nbsp;    public fun checkThemesCorrectness(colors: List&lt;Color&gt;) {
<b class="fc"><i class="no-highlight">119</i>&nbsp;        val colorsByTheme: Map&lt;String, List&lt;Color&gt;&gt; = colors.groupBy(Color::theme)</b>
<b class="fc"><i class="no-highlight">120</i>&nbsp;        val numberOfThemes: Int = colorsByTheme.keys.size</b>
<i class="no-highlight">121</i>&nbsp;
<b class="pc"><i class="no-highlight">122</i>&nbsp;        check(numberOfThemes &gt; 1) {</b>
<b class="nc"><i class="no-highlight">123</i>&nbsp;            &quot;To check the correctness of all themes is necessary to provide two or more themes&quot;</b>
<i class="no-highlight">124</i>&nbsp;        }
<i class="no-highlight">125</i>&nbsp;
<b class="fc"><i class="no-highlight">126</i>&nbsp;        val missingColors: List&lt;Color&gt; =</b>
<b class="fc"><i class="no-highlight">127</i>&nbsp;            colorsByTheme.values.flatten().mapNotNull { color -&gt;</b>
<b class="pc"><i class="no-highlight">128</i>&nbsp;                if (colorsByTheme.all { (_, colors) -&gt; colors.any { it.path == color.path } }) null</b>
<b class="nc"><i class="no-highlight">129</i>&nbsp;                else color</b>
<i class="no-highlight">130</i>&nbsp;            }
<i class="no-highlight">131</i>&nbsp;
<b class="pc"><i class="no-highlight">132</i>&nbsp;        check(missingColors.isEmpty()) {</b>
<b class="nc"><i class="no-highlight">133</i>&nbsp;            &quot;&quot;&quot;</b>
<i class="no-highlight">134</i>&nbsp;                |The next colors are missing in some theme: 
<b class="nc"><i class="no-highlight">135</i>&nbsp;                ${missingColors.joinToString(&quot;\n&quot;) { &quot;|  - ${it.theme}: ${it.path}&quot; } }</b>
<b class="nc"><i class="no-highlight">136</i>&nbsp;            &quot;&quot;&quot;.trimMargin()</b>
<i class="no-highlight">137</i>&nbsp;        }
<i class="no-highlight">138</i>&nbsp;    }
<i class="no-highlight">139</i>&nbsp;}
</div>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
        var codeBlock = document.getElementById('sourceCode');

        if (codeBlock) {
            hljs.highlightBlock(codeBlock);
        }
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2022-07-20 11:27</div>
</div>
</body>
</html>
